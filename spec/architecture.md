# Ultimate Mac Developer Environment Setup Script システムアーキテクチャ

**作成日**: 2025-07-23
**関連仕様**: [requirements.md](./requirements.md) | [design.md](./design.md)

## アーキテクチャ概要

本システムは、モノリシックなbashスクリプトとして実装されているが、内部的にはモジュラー構造を採用している。各機能は独立した関数として実装され、明確な責任分離と高い保守性を実現している。

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                         ユーザー                              │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    メインスクリプト                           │
│                 (mac-setup-modular.sh)                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐  │
│  │   初期化    │  │ メニューUI   │  │  実行制御      │  │
│  │  モジュール  │  │  モジュール   │  │  モジュール     │  │
│  └─────────────┘  └──────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │               コア機能モジュール                       │  │
│  ├─────────────┬──────────────┬────────────┬──────────┤  │
│  │システムチェック│インストーラー  │ 設定管理   │ユーティリティ│  │
│  └─────────────┴──────────────┴────────────┴──────────┘  │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    外部システム                               │
├──────────────┬──────────────┬────────────┬─────────────────┤
│   Homebrew   │  各種パッケージ │   macOS    │  設定ファイル    │
│              │  マネージャー   │  システム   │  (~/.zshrc等)   │
└──────────────┴──────────────┴────────────┴─────────────────┘
```

## モジュール詳細

### 1. 初期化モジュール

**責任範囲**: システムの初期化と前提条件の確認

```bash
# 主要関数
- check_macos_version()    # macOSバージョン確認
- detect_architecture()    # CPUアーキテクチャ検出
- check_sudo_access()     # 権限確認
- setup_colors()          # カラー定義
```

### 2. メニューUIモジュール

**責任範囲**: ユーザーインタラクションとメニュー表示

```bash
# 主要関数
- show_menu()            # メインメニュー
- checkbox_menu()        # チェックボックスUI
- custom_setup()         # カスタムセットアップメニュー
- confirm_selection()    # 選択確認
```

### 3. 実行制御モジュール

**責任範囲**: スクリプトの実行フローと状態管理

```bash
# 主要関数
- main()                 # メインループ
- execute_setup()        # セットアップ実行制御
- handle_exit()          # 終了処理
- trap_errors()          # エラートラップ
```

### 4. システムチェックモジュール

**責任範囲**: システム状態の確認と検証

```bash
# 主要関数
- check_internet_connection()  # ネットワーク確認
- check_disk_space()          # ディスク容量確認
- check_existing_tools()      # 既存ツール確認
- validate_environment()      # 環境検証
```

### 5. インストーラーモジュール

**責任範囲**: 各種ツールのインストール処理

```bash
# 基本インストール
- install_xcode_cli()         # Xcode CLT
- install_homebrew()          # Homebrew

# カテゴリ別インストール
- install_basic_tools()       # 基本ツール
- install_programming_languages()  # プログラミング言語
- install_databases()         # データベース
- install_dev_tools()         # 開発ツール
- install_productivity_tools() # 生産性ツール
```

### 6. 設定管理モジュール

**責任範囲**: 各種設定ファイルの生成と管理

```bash
# 主要関数
- setup_oh_my_zsh()          # Oh My Zsh設定
- configure_macos_settings()  # macOS設定
- setup_environment()        # 環境変数設定
- create_config_files()      # 設定ファイル生成
- backup_existing_configs()  # 既存設定バックアップ
```

### 7. ユーティリティモジュール

**責任範囲**: 共通機能とヘルパー関数

```bash
# 主要関数
- log()                      # ログ出力
- error()                    # エラー出力
- warning()                  # 警告出力
- info()                     # 情報出力
- show_progress()            # 進捗表示
- backup_file()              # ファイルバックアップ
```

## データフロー

### 1. 初期化フロー
```
開始 → システムチェック → 環境検証 → メニュー表示
```

### 2. インストールフロー
```
選択 → 確認 → バックアップ → インストール → 設定 → 検証
```

### 3. エラーハンドリングフロー
```
エラー発生 → ログ記録 → ロールバック → ユーザー通知 → 復旧オプション
```

## 依存関係

### 外部依存
1. **macOS システム**
   - システムコマンド (sw_vers, uname等)
   - セキュリティフレームワーク

2. **パッケージマネージャー**
   - Homebrew (メイン)
   - npm, pip, gem等 (言語別)

3. **ネットワーク**
   - パッケージリポジトリ
   - GitHubリリース

### 内部依存
```
ユーティリティ ← すべてのモジュール
     ↑
初期化モジュール ← メニューUI ← 実行制御
     ↑              ↑
システムチェック ← インストーラー ← 設定管理
```

## セキュリティアーキテクチャ

### 権限管理
- 最小権限の原則
- sudo使用の最小化
- 一時的な権限昇格

### データ保護
- 設定ファイルの適切な権限設定 (600/644)
- SSH鍵の安全な生成と保管
- パスワードの非保存

### 監査とログ
- すべての操作のログ記録
- エラーと警告の追跡
- インストール履歴の保持

## 拡張性

### プラグインアーキテクチャ
将来的な拡張のための設計：

```bash
# カスタムインストーラーの追加
custom_installers/
├── install_custom_tool1.sh
├── install_custom_tool2.sh
└── ...

# 設定プロファイル
profiles/
├── web_developer.conf
├── mobile_developer.conf
└── data_scientist.conf
```

### 設定のカスタマイズ
```bash
# 設定ファイル例
~/.mac-setup/config.yml
~/.mac-setup/custom-tools.txt
```

## パフォーマンス考慮事項

### 最適化戦略
1. **並列処理**
   - 独立したインストールの並列実行
   - バックグラウンドダウンロード

2. **キャッシュ活用**
   - Homebrewキャッシュ
   - ダウンロードファイルの再利用

3. **条件付き実行**
   - インストール済みツールのスキップ
   - 差分更新の実施

## 制約事項

1. **技術的制約**
   - bash 3.2互換性（macOSデフォルト）
   - POSIX準拠のコマンド使用

2. **環境制約**
   - インターネット接続必須
   - 最小10GBの空き容量

3. **運用制約**
   - 初回実行時の管理者権限
   - 実行時間（30分〜2時間）